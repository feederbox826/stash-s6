#!/bin/sh
set -e

# uv-pip: 'pip' to 'uv' shim
# AGPL-3.0-or-later	Â© feederbox826

VERSION="0.2"
_HELP="uv-pip: A wrapper for uv pip to act like pip

Usage:
  uv-pip install <package>
    Installs a package using uv pip install.

  uv-pip uninstall <package>
    Uninstalls a package using uv pip uninstall.

  uv-pip requirements <file>
    Installs packages from a requirements file using uv pip install -r <file>."

# if no arguments, print usage
[ $# -eq 0 ] && { echo "$_HELP"; exit 1; }

# exit early if no uv
command -v uv >/dev/null 2>&1 || { echo "Error: uv not found." >&2; exit 1; }

# stash logger
log() { level="$1"; shift; printf >&2 "\001%s\002uv: %s\n" "$level" "$*"; }

### log version
log "e" "attempting to install with uv-pip $VERSION"

# Handle only install and uninstall
cmd="$1"
# check for UV_TARGET
[ -z "$UV_TARGET" ] && { log "e" "UV_TARGET not set. Please set it to the target directory."; exit 1; }

shift
if [ "$cmd" = "install" ] || [ "$cmd" = "uninstall" ]; then
  log "d" "Running uv pip $cmd with target $UV_TARGET"
  uv pip "$cmd" --system --target "$UV_TARGET" "$@"
elif [ "$cmd" = "requirements" ]; then
  log "d" "Running uv pip install from requirements file with target $UV_TARGET"
  uv pip install --system --target "$UV_TARGET" -r "$1"
else
  log "e" "Unsupported pip subcommand: $cmd"
  exit 1
fi